<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WireHunt - Network Forensic Engine</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#1e1e2e;--surface:#313244;--overlay:#45475a;--text:#cdd6f4;--subtext:#a6adc8;--accent:#89b4fa;--green:#a6e3a1;--red:#f38ba8;--yellow:#f9e2af;--mauve:#cba6f7;--teal:#94e2d5;--pink:#f5c2e7;--peach:#fab387;--border:#585b70;--card:#181825;--client:#89b4fa;--server:#a6e3a1;--crust:#11111b}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:13px}
.header{background:var(--crust);border-bottom:1px solid var(--border);padding:8px 20px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:100}
.logo{font-size:20px;font-weight:800;letter-spacing:-0.5px}.logo span:first-child{color:var(--accent)}
.version{color:var(--subtext);font-size:11px}
.header-right{margin-left:auto;display:flex;gap:8px;align-items:center}
.btn{padding:5px 12px;border-radius:5px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;font-size:11px;transition:all .15s;font-family:inherit}
.btn:hover{border-color:var(--accent);color:var(--accent)}
.btn-primary{background:var(--accent);color:var(--crust);border-color:var(--accent);font-weight:600}
.btn-primary:hover{opacity:.85}
.container{max-width:1600px;margin:0 auto;padding:14px 18px}
.dropzone{border:2px dashed var(--border);border-radius:16px;padding:60px 40px;text-align:center;transition:all .2s;cursor:pointer;background:var(--card)}
.dropzone:hover,.dropzone.active{border-color:var(--accent);background:rgba(137,180,250,.05)}
.dropzone h2{font-size:18px;margin-bottom:6px}.dropzone p{color:var(--subtext);font-size:12px}
.dropzone .icon{font-size:36px;margin-bottom:10px;opacity:.6}.dropzone input{display:none}
.loading{text-align:center;padding:40px;display:none}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top:3px solid var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 10px}
@keyframes spin{to{transform:rotate(360deg)}}
.dashboard{display:none}

/* Executive summary */
.exec-summary{background:linear-gradient(135deg,rgba(137,180,250,.08),rgba(148,226,213,.06));border:1px solid var(--accent);border-radius:10px;padding:14px 18px;margin-bottom:14px;line-height:1.6;font-size:12px;color:var(--text)}
.exec-summary strong{color:var(--accent)}
.exec-summary .warn{color:var(--red);font-weight:700}

/* Flag banner */
.flag-banner{background:linear-gradient(135deg,rgba(243,139,168,.12),rgba(203,166,247,.12));border:1px solid var(--red);border-radius:10px;padding:12px 16px;margin-bottom:14px;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{border-color:var(--red)}50%{border-color:var(--mauve)}}
.flag-banner h3{color:var(--red);font-size:13px;margin-bottom:5px}
.flag-value{font-family:'Cascadia Code','Fira Code',monospace;background:rgba(243,139,168,.1);color:var(--red);padding:2px 7px;border-radius:4px;font-size:12px;font-weight:700;display:inline-block;margin:2px 3px 2px 0}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px}
@media(max-width:1000px){.grid-2,.grid-3{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:9px;padding:12px 14px}
.card h3{font-size:11px;color:var(--subtext);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.card h3 .cnt{color:var(--accent);font-weight:700}

/* MITRE */
.mitre-chain{display:flex;gap:4px;flex-wrap:wrap}
.mitre-phase{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:6px 8px;min-width:80px;flex:1}
.mitre-phase .phase-name{font-size:8px;text-transform:uppercase;letter-spacing:.4px;color:var(--subtext);margin-bottom:3px}
.mitre-phase .phase-tags{display:flex;flex-wrap:wrap;gap:2px}
.mitre-tag{font-size:8px;padding:1px 4px;border-radius:2px;background:rgba(203,166,247,.12);color:var(--mauve);font-weight:600}
.mitre-phase.active{border-color:var(--mauve);background:rgba(203,166,247,.05)}

/* Findings */
.finding-row{display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid rgba(88,91,112,.15);font-size:11px;cursor:pointer;transition:background .1s}
.finding-row:hover{background:rgba(137,180,250,.03);border-radius:3px}
.finding-row:last-child{border-bottom:none}
.sev{font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;min-width:50px;text-align:center;text-transform:uppercase}
.sev-critical{background:rgba(243,139,168,.2);color:var(--red)}.sev-high{background:rgba(250,179,135,.15);color:var(--peach)}
.sev-medium{background:rgba(249,226,175,.15);color:var(--yellow)}.sev-low{background:rgba(148,226,213,.15);color:var(--teal)}
.sev-info{background:rgba(166,173,200,.1);color:var(--subtext)}
.mitre{font-size:8px;color:var(--mauve);background:rgba(203,166,247,.1);padding:1px 4px;border-radius:2px}

/* File bar */
.file-bar{display:flex;flex-wrap:wrap;gap:14px;background:var(--card);border:1px solid var(--border);border-radius:9px;padding:10px 14px;margin-bottom:12px;font-size:11px}
.file-bar .lbl{color:var(--subtext);font-size:9px;text-transform:uppercase;letter-spacing:.4px}
.file-bar .val{font-weight:600;word-break:break-all}.file-bar .hash{font-family:monospace;font-size:9px;color:var(--accent)}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:14px}
.stat{background:var(--card);border:1px solid var(--border);border-radius:7px;padding:10px 8px;text-align:center}
.stat .v{font-size:22px;font-weight:800}.stat .l{color:var(--subtext);font-size:9px;text-transform:uppercase;letter-spacing:.4px;margin-top:1px}
.stat.a .v{color:var(--accent)}.stat.g .v{color:var(--green)}.stat.y .v{color:var(--yellow)}.stat.r .v{color:var(--red)}.stat.m .v{color:var(--mauve)}.stat.t .v{color:var(--teal)}

/* Proto bars / talkers */
.proto-bar{display:flex;align-items:center;gap:6px;padding:2px 0;font-size:11px}
.proto-bar .name{min-width:60px;color:var(--accent);font-weight:600;font-size:11px}
.proto-bar .bar{flex:1;height:16px;background:var(--surface);border-radius:3px;overflow:hidden}
.proto-bar .fill{height:100%;border-radius:3px;transition:width .5s}
.proto-bar .count{min-width:60px;text-align:right;color:var(--subtext);font-size:10px}
.talker-row{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:11px;border-bottom:1px solid rgba(88,91,112,.1)}
.talker-row .ip{font-family:monospace;font-size:10px;color:var(--accent);min-width:120px}
.talker-row .bytes{color:var(--subtext);min-width:60px;text-align:right;font-size:10px}
.talker-row .bar{flex:1;height:10px;background:var(--surface);border-radius:2px;overflow:hidden}
.talker-row .fill{height:100%;border-radius:2px}

/* IOC enrichment */
.ioc-kind{font-size:9px;font-weight:600;padding:2px 5px;border-radius:3px;text-transform:uppercase}
.ioc-ip{background:rgba(137,180,250,.12);color:var(--accent)}.ioc-domain{background:rgba(166,227,161,.12);color:var(--green)}
.ioc-url{background:rgba(249,226,175,.12);color:var(--yellow)}.ioc-hash{background:rgba(250,179,135,.12);color:var(--peach)}
.ioc-ja3{background:rgba(203,166,247,.12);color:var(--mauve)}.ioc-ua{background:rgba(148,226,213,.12);color:var(--teal)}
.rep-bar{width:40px;height:7px;background:var(--surface);border-radius:3px;display:inline-block;vertical-align:middle;margin-right:3px;overflow:hidden}
.rep-fill{height:100%;border-radius:3px}
.badge-mal{font-size:8px;padding:1px 5px;border-radius:2px;font-weight:700;background:rgba(243,139,168,.2);color:var(--red)}
.badge-clean{font-size:8px;padding:1px 5px;border-radius:2px;font-weight:700;background:rgba(166,227,161,.15);color:var(--green)}
.enriching{color:var(--subtext);font-size:10px;font-style:italic}
.geo-flag{font-size:12px;margin-right:2px}
.ext-link{font-size:9px;color:var(--accent);text-decoration:none;margin:0 2px}
.ext-link:hover{text-decoration:underline}

/* Search + Tabs */
.search-bar{margin-bottom:10px}
.search-bar input{width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:12px;font-family:inherit;outline:none}
.search-bar input:focus{border-color:var(--accent)}.search-bar input::placeholder{color:var(--overlay)}
.tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);margin-bottom:12px;overflow-x:auto}
.tab{padding:7px 12px;cursor:pointer;color:var(--subtext);border-bottom:2px solid transparent;transition:all .12s;font-size:11px;font-weight:500;white-space:nowrap}
.tab:hover{color:var(--text)}.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab .cnt{font-size:9px;color:var(--overlay);margin-left:3px}

/* Tables */
.panel{background:var(--card);border:1px solid var(--border);border-radius:9px;overflow:hidden;display:none}
.panel.active{display:block}
table{width:100%;border-collapse:collapse;font-size:10px}
th{text-align:left;padding:6px 10px;color:var(--subtext);font-weight:600;font-size:9px;text-transform:uppercase;letter-spacing:.4px;background:var(--surface);position:sticky;top:0}
td{padding:5px 10px;border-top:1px solid rgba(88,91,112,.15)}
tr:hover td{background:rgba(137,180,250,.03)}
.proto-badge{font-weight:700;font-size:9px;padding:2px 5px;border-radius:3px;display:inline-block}
.pb-tcp{background:rgba(137,180,250,.15);color:var(--accent)}.pb-udp{background:rgba(166,227,161,.15);color:var(--green)}.pb-icmp{background:rgba(249,226,175,.15);color:var(--yellow)}
.m-GET{color:var(--green);font-weight:700}.m-POST{color:var(--yellow);font-weight:700}.m-PUT{color:var(--accent);font-weight:700}.m-DELETE{color:var(--red);font-weight:700}
.status{font-weight:700;font-size:9px;padding:1px 4px;border-radius:2px}
.s2{background:rgba(166,227,161,.15);color:var(--green)}.s3{background:rgba(249,226,175,.15);color:var(--yellow)}.s4{background:rgba(250,179,135,.15);color:var(--peach)}.s5{background:rgba(243,139,168,.15);color:var(--red)}
.dir{font-size:9px;font-weight:600;padding:1px 4px;border-radius:2px}
.dir-q{background:rgba(137,180,250,.12);color:var(--accent)}.dir-r{background:rgba(166,227,161,.12);color:var(--green)}
.cred-secret{font-family:'Cascadia Code',monospace;color:var(--red);font-size:9px;background:rgba(243,139,168,.06);padding:1px 3px;border-radius:2px;word-break:break-all}
.mono{font-family:'Cascadia Code','Fira Code',monospace;font-size:9px}
.empty{padding:20px;text-align:center;color:var(--overlay);font-size:11px}
.flag-highlight{background:rgba(243,139,168,.15);color:var(--red);font-weight:700;padding:0 2px;border-radius:2px}

/* Host cards */
.host-card{background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:8px 10px;margin-bottom:6px;font-size:10px}
.host-card .ip{font-family:monospace;color:var(--accent);font-weight:700;font-size:12px}
.host-card .hostnames{color:var(--green);font-size:9px}
.host-card .svc{display:inline-block;font-size:8px;padding:1px 4px;border-radius:2px;background:rgba(137,180,250,.1);color:var(--accent);margin:1px}
.host-meta{display:flex;gap:10px;margin-top:3px;color:var(--subtext);font-size:9px}

/* Timeline */
.tl-event{display:flex;align-items:flex-start;gap:8px;padding:3px 0;border-left:2px solid var(--border);margin-left:6px;padding-left:10px;font-size:10px}
.tl-event:hover{background:rgba(137,180,250,.02)}
.tl-dot{width:7px;height:7px;border-radius:50%;margin-top:3px;flex-shrink:0}
.tl-dot.critical{background:var(--red)}.tl-dot.high{background:var(--peach)}.tl-dot.medium{background:var(--yellow)}.tl-dot.low{background:var(--teal)}.tl-dot.info{background:var(--overlay)}
.tl-time{color:var(--subtext);font-size:9px;min-width:65px;font-family:monospace}
.tl-type{color:var(--mauve);font-size:8px;text-transform:uppercase;min-width:70px}

/* Network Graph */
.graph-container{position:relative;width:100%;height:450px;background:var(--bg);border:1px solid var(--border);border-radius:9px;overflow:hidden}
.graph-container canvas{width:100%;height:100%}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:200;display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--bg);border:1px solid var(--border);border-radius:10px;width:92%;max-width:1100px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column}
.modal-header{padding:10px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-header h3{color:var(--accent);font-size:13px}
.modal-body{padding:12px 16px;overflow-y:auto;flex:1}
.seg{margin-bottom:8px}
.seg-header{font-size:10px;font-weight:600;margin-bottom:3px;display:flex;align-items:center;gap:6px}
.seg-header .dir-client{color:var(--client)}.seg-header .dir-server{color:var(--server)}
.seg-content{font-family:'Cascadia Code',monospace;font-size:10px;line-height:1.5;padding:7px 10px;background:var(--card);border-radius:5px;border:1px solid var(--border);white-space:pre-wrap;word-break:break-all;max-height:220px;overflow-y:auto}
.seg-content.client{border-left:3px solid var(--client)}.seg-content.server{border-left:3px solid var(--server)}
.toggle-hex{font-size:9px;padding:2px 7px;border-radius:3px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer}
.toggle-hex.active{background:var(--accent);color:var(--bg);border-color:var(--accent)}
.detail-grid{display:grid;grid-template-columns:auto 1fr;gap:5px 10px;font-size:11px;margin-bottom:10px}
.detail-grid .lbl{color:var(--subtext);text-transform:uppercase;font-size:9px;letter-spacing:.3px}
.evidence-item{background:var(--card);border:1px solid var(--border);border-radius:5px;padding:6px 8px;margin-bottom:5px;font-size:10px}

/* Print */
@media print{
  body{background:#fff!important;color:#000!important;font-size:10px}
  .header,.dropzone,.loading,.search-bar,.tabs,.btn,.toggle-hex,.modal-overlay{display:none!important}
  .dashboard{display:block!important}
  .panel{display:block!important;page-break-inside:avoid;margin-bottom:12px;border:1px solid #ccc}
  .card,.stat,.file-bar,.exec-summary,.flag-banner,.graph-container{border:1px solid #ccc;background:#fff!important;color:#000!important}
  .sev,.mitre,.proto-badge,.ioc-kind,.dir,.status{border:1px solid #999}
  *{color:#000!important}
  .graph-container{height:300px}
}
</style>
</head>
<body>
<div class="header">
  <div class="logo"><span>WIRE</span><span>HUNT</span></div>
  <span class="version" id="ver"></span>
  <div class="header-right">
    <button class="btn" id="pdfBtn" style="display:none" onclick="window.print()">Export PDF</button>
    <button class="btn" id="exportBtn" style="display:none" onclick="exportJSON()">Export JSON</button>
    <button class="btn btn-primary" id="newBtn" style="display:none" onclick="reset()">New Scan</button>
  </div>
</div>
<div class="container">
  <div class="dropzone" id="dropzone" onclick="document.getElementById('fi').click()">
    <div class="icon">&#128194;</div>
    <h2>Drop your PCAP file here</h2>
    <p>or click to browse &mdash; .pcap and .pcapng up to 500 MB</p>
    <input type="file" id="fi" accept=".pcap,.pcapng,.cap"/>
  </div>
  <div class="loading" id="loading"><div class="spinner"></div><p>Analyzing capture...</p></div>
  <div class="dashboard" id="dash"></div>
</div>
<div class="modal-overlay" id="modal"><div class="modal"><div class="modal-header"><h3 id="modalTitle">Detail</h3><div><button class="btn" style="margin-right:4px" id="copyBtn" onclick="copyStream()">Copy</button><button class="btn" onclick="closeModal()">Close</button></div></div><div class="modal-body" id="modalBody"></div></div></div>
<script>
let R=null,enrichData=null;
const $=s=>document.querySelector(s);
const dz=$('#dropzone'),fi=$('#fi');
['dragenter','dragover'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.add('active')}));
['dragleave','drop'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.remove('active')}));
dz.addEventListener('drop',ev=>{if(ev.dataTransfer.files[0])upload(ev.dataTransfer.files[0])});
fi.addEventListener('change',()=>{if(fi.files[0])upload(fi.files[0])});

async function upload(file){
  dz.style.display='none';$('#loading').style.display='block';
  const form=new FormData();form.append('pcap',file);
  try{const res=await fetch('/api/analyze',{method:'POST',body:form});if(!res.ok)throw new Error(await res.text());R=await res.json();$('#loading').style.display='none';render();enrichIocs()}
  catch(e){$('#loading').style.display='none';dz.style.display='block';alert('Error: '+e.message)}
}
function reset(){$('#dash').style.display='none';$('#dash').innerHTML='';dz.style.display='block';fi.value='';$('#exportBtn').style.display='none';$('#newBtn').style.display='none';$('#pdfBtn').style.display='none';R=null;enrichData=null}
function exportJSON(){if(!R)return;const b=new Blob([JSON.stringify(R,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='wirehunt_report.json';a.click()}

async function enrichIocs(){
  try{const res=await fetch('/api/enrich',{method:'POST'});if(res.ok){enrichData=await res.json();updateIocTable()}}catch(e){}
}

function updateIocTable(){
  if(!enrichData||!enrichData.length)return;
  const map={};enrichData.forEach(e=>map[e.ioc_id]=e);
  document.querySelectorAll('.ioc-enrich-cell').forEach(cell=>{
    const id=cell.dataset.iocId;const e=map[id];if(!e)return;
    let h='';
    if(e.geo&&e.geo.country_code)h+=`<span class="geo-flag">${countryFlag(e.geo.country_code)}</span>`;
    if(e.geo&&e.geo.org)h+=`<span style="font-size:9px;color:var(--subtext)">${esc(e.geo.org)}</span> `;
    if(e.is_malicious===true)h+=`<span class="badge-mal">MALICIOUS</span> `;
    else if(e.is_malicious===false&&e.sources.length>0)h+=`<span class="badge-clean">CLEAN</span> `;
    if(e.reputation_score!=null){const c=e.reputation_score>50?'var(--red)':e.reputation_score>20?'var(--yellow)':'var(--green)';h+=`<span class="rep-bar"><span class="rep-fill" style="width:${e.reputation_score}%;background:${c}"></span></span>${e.reputation_score}% `}
    e.sources.forEach(s=>{if(s.link)h+=`<a href="${s.link}" target="_blank" class="ext-link">${s.provider}</a>`});
    cell.innerHTML=h||'<span class="enriching">-</span>';
  });
}

function countryFlag(cc){if(!cc||cc.length!==2)return'';const a=0x1F1E6;return String.fromCodePoint(a+cc.charCodeAt(0)-97)+String.fromCodePoint(a+cc.charCodeAt(1)-97)}

const MITRE_PHASES={
  'Reconnaissance':['T1595','T1592','T1589','T1590','T1591','T1596','T1597','T1598'],
  'Initial Access':['T1190','T1189','T1566','T1133','T1200','T1078'],
  'Execution':['T1059','T1053','T1047','T1203','T1204'],
  'Persistence':['T1098','T1136','T1543','T1547','T1574'],
  'Priv. Esc.':['T1548','T1134','T1068'],
  'Def. Evasion':['T1070','T1036','T1027','T1055','T1562'],
  'Cred. Access':['T1110','T1003','T1552','T1555','T1556','T1040','T1557','T1558'],
  'Discovery':['T1083','T1046','T1135','T1082','T1049','T1016','T1018'],
  'Lat. Movement':['T1021','T1091','T1570'],
  'Collection':['T1560','T1119','T1005','T1039','T1074'],
  'C2':['T1071','T1095','T1105','T1090','T1572','T1573','T1568','T1001','T1102','T1571'],
  'Exfiltration':['T1041','T1048','T1567','T1029','T1030','T1020','T1537'],
  'Impact':['T1485','T1486','T1489','T1490','T1491','T1498','T1499']
};

function render(){
  const d=$('#dash');d.style.display='block';$('#exportBtn').style.display='inline-block';$('#newBtn').style.display='inline-block';$('#pdfBtn').style.display='inline-block';
  const m=R.metadata;$('#ver').textContent='v'+m.wirehunt_version;
  const flags=R.findings.filter(f=>f.category==='ctf_flag');
  let allMitre=new Set();R.findings.forEach(f=>f.mitre_attack.forEach(t=>{allMitre.add(t.split('.')[0]);allMitre.add(t)}));
  (R.iocs||[]).forEach(i=>(i.mitre_attack||[]).forEach(t=>{allMitre.add(t.split('.')[0]);allMitre.add(t)}));
  let h='';

  // Executive summary
  if(R.executive_summary){
    let summary=esc(R.executive_summary);
    summary=summary.replace(/(DATA EXFILTRATION INDICATORS|C2 INDICATORS|WARNING|MITRE ATT&amp;CK coverage)/g,'<strong class="warn">$1</strong>');
    summary=summary.replace(/(CTF Flags found)/g,'<strong>$1</strong>');
    summary=summary.replace(/(\d+ critical|\d+ high)/gi,'<strong class="warn">$1</strong>');
    h+=`<div class="exec-summary">${summary}</div>`;
  }

  // Flag banner
  if(flags.length>0){h+=`<div class="flag-banner"><h3>&#127937; ${flags.length} CTF Flag${flags.length>1?'s':''} Found!</h3><div>`;flags.forEach(f=>{const val=f.title.replace('CTF Flag Found: ','');h+=`<span class="flag-value">${esc(val)}</span>`});h+=`</div></div>`}

  // MITRE
  if(allMitre.size>0){
    h+=`<div class="card" style="margin-bottom:12px"><h3>MITRE ATT&CK Coverage</h3><div class="mitre-chain">`;
    Object.entries(MITRE_PHASES).forEach(([phase,techs])=>{const matched=techs.filter(t=>allMitre.has(t));const active=matched.length>0;
      h+=`<div class="mitre-phase${active?' active':''}"><div class="phase-name">${phase}</div><div class="phase-tags">`;
      if(active)matched.forEach(t=>h+=`<span class="mitre-tag">${t}</span>`);
      else h+=`<span style="font-size:8px;color:var(--overlay)">-</span>`;
      h+=`</div></div>`});
    h+=`</div></div>`;
  }

  // File info
  h+=`<div class="file-bar"><div><div class="lbl">File</div><div class="val">${esc(m.pcap_filename)}</div></div><div><div class="lbl">SHA256</div><div class="val hash">${m.pcap_sha256.slice(0,20)}...</div></div><div><div class="lbl">Size</div><div class="val">${fmtB(m.pcap_size_bytes)}</div></div><div><div class="lbl">Packets</div><div class="val">${m.total_packets.toLocaleString()}</div></div><div><div class="lbl">Duration</div><div class="val">${m.capture_duration_secs.toFixed(1)}s</div></div><div><div class="lbl">Profile</div><div class="val">${m.profile}</div></div></div>`;

  // Stats
  const nIoc=(R.iocs||[]).length,nHost=(R.host_profiles||[]).length,nTl=(R.timeline||[]).length,nTls=(R.tls_sessions||[]).length;
  h+=`<div class="stats">
    <div class="stat a"><div class="v">${R.flows.length}</div><div class="l">Flows</div></div>
    <div class="stat g"><div class="v">${R.streams.length}</div><div class="l">Streams</div></div>
    <div class="stat ${R.findings.length?'r':''}"><div class="v">${R.findings.length}</div><div class="l">Findings</div></div>
    <div class="stat ${R.credentials.length?'r':''}"><div class="v">${R.credentials.length}</div><div class="l">Credentials</div></div>
    <div class="stat y"><div class="v">${R.artifacts.length}</div><div class="l">Artifacts</div></div>
    <div class="stat m"><div class="v">${nIoc}</div><div class="l">IOCs</div></div>
    <div class="stat"><div class="v">${R.dns_records.length}</div><div class="l">DNS</div></div>
    <div class="stat"><div class="v">${R.http_transactions.length}</div><div class="l">HTTP</div></div>
    <div class="stat t"><div class="v">${nTls}</div><div class="l">TLS</div></div>
    <div class="stat"><div class="v">${nHost}</div><div class="l">Hosts</div></div></div>`;

  // Grid: Findings + Protocol + Top Talkers
  h+=`<div class="grid-3">`;
  h+=`<div class="card" style="max-height:280px;overflow-y:auto"><h3>Findings <span class="cnt">${R.findings.length}</span></h3>`;
  if(!R.findings.length)h+=`<div class="empty">No findings</div>`;
  R.findings.slice(0,20).forEach((f,i)=>{const mitreH=f.mitre_attack.map(t=>`<span class="mitre">${t}</span>`).join(' ');
    h+=`<div class="finding-row" onclick="openFinding(${i})"><span class="sev sev-${f.severity}">${f.severity}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(f.title)}</span><span style="color:var(--subtext);font-size:9px">${(f.confidence*100).toFixed(0)}%</span>${mitreH}</div>`});
  if(R.findings.length>20)h+=`<div style="padding:4px;color:var(--subtext);font-size:10px">+${R.findings.length-20} more</div>`;
  h+=`</div>`;

  const pb=R.statistics.protocol_breakdown;const total=Object.values(pb).reduce((a,b)=>a+b,0);const sorted=Object.entries(pb).sort((a,b)=>b[1]-a[1]);
  const colors=['var(--accent)','var(--green)','var(--yellow)','var(--mauve)','var(--teal)','var(--pink)','var(--peach)'];
  h+=`<div class="card"><h3>Protocol Breakdown</h3>`;
  sorted.forEach(([name,count],i)=>{const pct=total>0?(count/total*100):0;h+=`<div class="proto-bar"><span class="name">${name}</span><div class="bar"><div class="fill" style="width:${pct}%;background:${colors[i%colors.length]}"></div></div><span class="count">${count} (${pct.toFixed(0)}%)</span></div>`});
  h+=`</div>`;

  const talkers=R.statistics.top_talkers||[];
  h+=`<div class="card" style="max-height:280px;overflow-y:auto"><h3>Top Talkers <span class="cnt">${talkers.length}</span></h3>`;
  const maxB=talkers.length>0?talkers[0][1]:1;
  talkers.slice(0,12).forEach(([ip,bytes])=>{const pct=bytes/maxB*100;h+=`<div class="talker-row"><span class="ip">${ip}</span><div class="bar"><div class="fill" style="width:${pct}%;background:var(--accent)"></div></div><span class="bytes">${fmtB(bytes)}</span></div>`});
  h+=`</div></div>`;

  h+=`<div class="search-bar"><input type="text" placeholder="Search across all tables..." oninput="filterTables(this.value)"/></div>`;

  // Tabs
  const tabs=[{id:'flows',l:'Flows',c:R.flows.length},{id:'streams',l:'Streams',c:R.streams.length},{id:'http',l:'HTTP',c:R.http_transactions.length},{id:'dns',l:'DNS',c:R.dns_records.length},{id:'tls',l:'TLS',c:nTls},{id:'creds',l:'Credentials',c:R.credentials.length},{id:'artifacts',l:'Artifacts',c:R.artifacts.length},{id:'iocs',l:'IOCs',c:nIoc},{id:'hosts',l:'Hosts',c:nHost},{id:'graph',l:'Network Graph',c:''},{id:'timeline',l:'Timeline',c:nTl}];
  h+=`<div class="tabs">${tabs.map((t,i)=>`<div class="tab${i===0?' active':''}" data-p="${t.id}" onclick="switchTab(this)">${t.l}${t.c!==''?`<span class="cnt">${t.c}</span>`:''}</div>`).join('')}</div>`;

  // FLOWS
  h+=`<div class="panel active" id="p-flows"><table><thead><tr><th>#</th><th>Proto</th><th>Source</th><th>Destination</th><th>Pkts</th><th>Bytes</th><th>App</th><th>Duration</th><th>Flags</th><th></th></tr></thead><tbody class="filterable">`;
  R.flows.forEach((f,i)=>{const p=f.key.protocol;const pc=p==='tcp'?'pb-tcp':p==='udp'?'pb-udp':'pb-icmp';
    const fl=[];if(f.flags.syn)fl.push('SYN');if(f.flags.syn_ack)fl.push('SA');if(f.flags.fin)fl.push('FIN');if(f.flags.rst)fl.push('RST');
    const dur=(f.duration_us/1000000).toFixed(2)+'s';
    const streamIdx=f.stream_ids&&f.stream_ids.length?R.streams.findIndex(s=>s.id===f.stream_ids[0]):-1;
    h+=`<tr><td>${i}</td><td><span class="proto-badge ${pc}">${p.toUpperCase()}</span></td><td class="mono">${f.key.src_ip}:${f.key.src_port}</td><td class="mono">${f.key.dst_ip}:${f.key.dst_port}</td><td>${f.packet_count}</td><td>${fmtB(f.byte_count)}</td><td>${f.detected_protocol||'-'}</td><td style="color:var(--subtext)">${dur}</td><td style="font-size:9px;color:var(--subtext)">${fl.join(' ')}</td><td>${streamIdx>=0?`<button class="btn" style="padding:1px 6px;font-size:9px" onclick="openStream(${streamIdx})">Follow</button>`:''}</td></tr>`});
  h+=`</tbody></table></div>`;

  // STREAMS
  h+=`<div class="panel" id="p-streams"><table><thead><tr><th>#</th><th>Proto</th><th>Bytes</th><th>Segs</th><th>Preview</th><th></th></tr></thead><tbody class="filterable">`;
  R.streams.forEach((s,i)=>{let prev='';if(s.segments.length>0){const b=s.segments[0].data;prev=b.map(c=>c>=32&&c<127?String.fromCharCode(c):'.').join('').slice(0,50)}
    h+=`<tr><td>${i}</td><td>${s.protocol}</td><td>${fmtB(s.total_bytes)}</td><td>${s.segments.length}</td><td class="mono" style="color:var(--subtext)">${highlightFlags(esc(prev))}</td><td><button class="btn" style="padding:1px 6px;font-size:9px" onclick="openStream(${i})">View</button></td></tr>`});
  h+=`</tbody></table></div>`;

  // HTTP
  h+=`<div class="panel" id="p-http"><table><thead><tr><th>#</th><th>Method</th><th>Status</th><th>Host</th><th>URI</th><th>Type</th><th>Resp</th><th>Agent</th></tr></thead><tbody class="filterable">`;
  R.http_transactions.forEach((t,i)=>{const sc=t.status_code;const scl=sc?sc<300?'s2':sc<400?'s3':sc<500?'s4':'s5':'';
    h+=`<tr><td>${i}</td><td class="m-${t.method}">${t.method}</td><td>${sc?`<span class="status ${scl}">${sc}</span>`:'-'}</td><td>${esc(t.host||'-')}</td><td class="mono">${esc(t.uri)}</td><td style="font-size:9px">${esc(t.content_type||'-')}</td><td>${fmtB(t.response_body_size)}</td><td style="font-size:9px;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--subtext)">${esc(t.user_agent||'-')}</td></tr>`});
  h+=`</tbody></table></div>`;

  // DNS
  h+=`<div class="panel" id="p-dns"><table><thead><tr><th>#</th><th>Dir</th><th>Type</th><th>Query Name</th><th>Response</th><th>TTL</th><th>RCode</th></tr></thead><tbody class="filterable">`;
  R.dns_records.forEach((d,i)=>{h+=`<tr><td>${i}</td><td><span class="dir ${d.is_response?'dir-r':'dir-q'}">${d.is_response?'R':'Q'}</span></td><td style="color:var(--accent)">${d.record_type}</td><td class="mono">${highlightFlags(esc(d.query_name))}</td><td class="mono">${highlightFlags(esc(d.response_data.join(', ')))}</td><td style="color:var(--subtext)">${d.ttl||'-'}</td><td>${esc(d.response_code||'-')}</td></tr>`});
  h+=`</tbody></table></div>`;

  // TLS
  h+=`<div class="panel" id="p-tls"><table><thead><tr><th>#</th><th>Ver</th><th>SNI</th><th>Cipher</th><th>ALPN</th><th>JA3</th><th>JA3S</th><th>Subject</th><th>Self-Sign</th></tr></thead><tbody class="filterable">`;
  (R.tls_sessions||[]).forEach((t,i)=>{const ss=t.is_self_signed===true?'<span style="color:var(--red)">YES</span>':t.is_self_signed===false?'No':'-';
    h+=`<tr><td>${i}</td><td style="color:var(--accent)">${esc(t.version)}</td><td class="mono">${esc(t.sni||'-')}</td><td style="font-size:9px">${esc(t.cipher_suite||'-')}</td><td style="font-size:9px">${(t.alpn||[]).join(', ')||'-'}</td><td class="mono" style="font-size:8px">${(t.ja3_hash||'-').slice(0,14)}..</td><td class="mono" style="font-size:8px">${(t.ja3s_hash||'-').slice(0,14)}..</td><td style="font-size:9px">${esc(t.cert_subject||'-')}</td><td>${ss}</td></tr>`});
  h+=`</tbody></table></div>`;

  // CREDENTIALS
  h+=`<div class="panel" id="p-creds"><table><thead><tr><th>#</th><th>Type</th><th>User</th><th>Service</th><th>Host</th><th>Secret</th></tr></thead><tbody class="filterable">`;
  R.credentials.forEach((c,i)=>{h+=`<tr><td>${i}</td><td style="color:var(--yellow)">${esc(c.kind)}</td><td>${esc(c.username||'-')}</td><td>${esc(c.service||'-')}</td><td>${esc(c.host||'-')}</td><td><span class="cred-secret">${esc(c.secret.slice(0,80))}</span></td></tr>`});
  h+=`</tbody></table></div>`;

  // ARTIFACTS
  h+=`<div class="panel" id="p-artifacts"><table><thead><tr><th>#</th><th>Type</th><th>Name</th><th>Size</th><th>MIME</th><th>SHA256</th></tr></thead><tbody class="filterable">`;
  R.artifacts.forEach((a,i)=>{h+=`<tr><td>${i}</td><td style="color:var(--yellow)">${esc(a.kind)}</td><td>${esc(a.name||'-')}</td><td>${fmtB(a.size_bytes)}</td><td style="font-size:9px">${esc(a.mime_type||'-')}</td><td class="mono" style="font-size:8px">${a.sha256.slice(0,20)}...</td></tr>`});
  h+=`</tbody></table></div>`;

  // IOCs
  h+=`<div class="panel" id="p-iocs"><table><thead><tr><th>#</th><th>Type</th><th>Value</th><th>Description</th><th>Conf</th><th>MITRE</th><th>Intel</th></tr></thead><tbody class="filterable">`;
  (R.iocs||[]).forEach((ioc,i)=>{
    const kindCls={'ip_address':'ioc-ip','domain':'ioc-domain','url':'ioc-url','file_hash':'ioc-hash','ja3_fingerprint':'ioc-ja3','ja3s_fingerprint':'ioc-ja3','user_agent':'ioc-ua'}[ioc.kind]||'';
    const confPct=(ioc.confidence*100).toFixed(0);const confColor=ioc.confidence>0.7?'var(--red)':ioc.confidence>0.4?'var(--yellow)':'var(--subtext)';
    const mitreH=(ioc.mitre_attack||[]).map(t=>`<span class="mitre">${t}</span>`).join(' ');
    h+=`<tr><td>${i}</td><td><span class="ioc-kind ${kindCls}">${ioc.kind}</span></td><td class="mono" style="word-break:break-all;max-width:250px">${esc(ioc.value)}</td><td style="font-size:9px;max-width:180px">${esc(ioc.description||'-')}</td><td><span class="rep-bar"><span class="rep-fill" style="width:${confPct}%;background:${confColor}"></span></span>${confPct}%</td><td>${mitreH}</td><td class="ioc-enrich-cell" data-ioc-id="${ioc.id}"><span class="enriching">loading...</span></td></tr>`});
  h+=`</tbody></table></div>`;

  // HOSTS
  h+=`<div class="panel" id="p-hosts" style="padding:10px;max-height:450px;overflow-y:auto">`;
  (R.host_profiles||[]).slice(0,50).forEach(hp=>{const totalB=hp.total_bytes_sent+hp.total_bytes_received;
    const svcs=(hp.services||[]).map(s=>`<span class="svc">${s.port}/${s.protocol}${s.app_protocol?' '+s.app_protocol:''}</span>`).join('');
    h+=`<div class="host-card"><div class="ip">${hp.ip}</div>`;
    if(hp.hostnames&&hp.hostnames.length)h+=`<div class="hostnames">${hp.hostnames.join(', ')}</div>`;
    h+=`<div class="host-meta"><span>Flows: ${hp.total_flows}</span><span>Sent: ${fmtB(hp.total_bytes_sent)}</span><span>Recv: ${fmtB(hp.total_bytes_received)}</span><span>Total: ${fmtB(totalB)}</span></div>`;
    if(svcs)h+=`<div style="margin-top:3px">${svcs}</div>`;h+=`</div>`});
  if(!(R.host_profiles||[]).length)h+=`<div class="empty">No host profiles</div>`;
  h+=`</div>`;

  // NETWORK GRAPH
  h+=`<div class="panel" id="p-graph"><div class="graph-container"><canvas id="netCanvas"></canvas></div></div>`;

  // TIMELINE
  h+=`<div class="panel" id="p-timeline" style="padding:10px;max-height:450px;overflow-y:auto">`;
  (R.timeline||[]).slice(0,300).forEach(ev=>{const sev=(ev.severity||'info').toLowerCase();
    const ts=ev.timestamp?new Date(ev.timestamp).toISOString().replace('T',' ').slice(11,19):'--:--:--';
    h+=`<div class="tl-event"><span class="tl-dot ${sev}"></span><span class="tl-time">${ts}</span><span class="tl-type">${esc(ev.event_type)}</span><span style="flex:1">${esc(ev.summary)}</span></div>`});
  if(!(R.timeline||[]).length)h+=`<div class="empty">No timeline events</div>`;
  h+=`</div>`;

  d.innerHTML=h;
  setTimeout(drawGraph,100);
}

// Network Graph (force-directed, pure Canvas)
function drawGraph(){
  const canvas=document.getElementById('netCanvas');if(!canvas)return;
  const rect=canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width*2;canvas.height=rect.height*2;
  canvas.style.width=rect.width+'px';canvas.style.height=rect.height+'px';
  const ctx=canvas.getContext('2d');ctx.scale(2,2);
  const W=rect.width,H=rect.height;

  const ipSet=new Set();const edges=[];
  R.flows.forEach(f=>{ipSet.add(f.key.src_ip);ipSet.add(f.key.dst_ip);
    edges.push({src:f.key.src_ip,dst:f.key.dst_ip,bytes:f.byte_count,proto:f.key.protocol,app:f.detected_protocol})});
  const ips=[...ipSet];if(!ips.length)return;

  const bytesByIp={};R.flows.forEach(f=>{bytesByIp[f.key.src_ip]=(bytesByIp[f.key.src_ip]||0)+f.fwd_bytes;bytesByIp[f.key.dst_ip]=(bytesByIp[f.key.dst_ip]||0)+f.rev_bytes});
  const maxBytes=Math.max(...Object.values(bytesByIp),1);

  const priv=['10.','172.16.','172.17.','172.18.','172.19.','172.20.','172.21.','172.22.','172.23.','172.24.','172.25.','172.26.','172.27.','172.28.','172.29.','172.30.','172.31.','192.168.','127.'];
  const isPriv=ip=>priv.some(p=>ip.startsWith(p));

  const nodes=ips.map((ip,i)=>{const angle=2*Math.PI*i/ips.length;return{ip,x:W/2+Math.cos(angle)*(W*0.3),y:H/2+Math.sin(angle)*(H*0.3),vx:0,vy:0,r:Math.max(6,Math.min(20,(bytesByIp[ip]||0)/maxBytes*18+5)),ext:!isPriv(ip)}});
  const nodeMap={};nodes.forEach(n=>nodeMap[n.ip]=n);

  for(let iter=0;iter<120;iter++){
    nodes.forEach(a=>{nodes.forEach(b=>{if(a===b)return;let dx=a.x-b.x,dy=a.y-b.y;const d=Math.max(Math.sqrt(dx*dx+dy*dy),1);const f=300/d;a.vx+=dx/d*f;a.vy+=dy/d*f})});
    edges.forEach(e=>{const a=nodeMap[e.src],b=nodeMap[e.dst];if(!a||!b)return;let dx=b.x-a.x,dy=b.y-a.y;const d=Math.max(Math.sqrt(dx*dx+dy*dy),1);const f=(d-100)*0.01;a.vx+=dx/d*f;a.vy+=dy/d*f;b.vx-=dx/d*f;b.vy-=dy/d*f});
    nodes.forEach(n=>{n.vx*=0.9;n.vy*=0.9;n.x+=n.vx;n.y+=n.vy;n.x=Math.max(n.r,Math.min(W-n.r,n.x));n.y=Math.max(n.r,Math.min(H-n.r,n.y))});
  }

  ctx.clearRect(0,0,W,H);
  edges.forEach(e=>{const a=nodeMap[e.src],b=nodeMap[e.dst];if(!a||!b)return;
    const thick=Math.max(1,Math.min(4,e.bytes/maxBytes*4));
    ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);
    ctx.strokeStyle=e.proto==='tcp'?'rgba(137,180,250,.3)':e.proto==='udp'?'rgba(166,227,161,.3)':'rgba(249,226,175,.3)';
    ctx.lineWidth=thick;ctx.stroke()});

  nodes.forEach(n=>{ctx.beginPath();ctx.arc(n.x,n.y,n.r,0,Math.PI*2);
    ctx.fillStyle=n.ext?'rgba(243,139,168,.8)':'rgba(137,180,250,.8)';ctx.fill();
    ctx.strokeStyle=n.ext?'#f38ba8':'#89b4fa';ctx.lineWidth=1.5;ctx.stroke();
    ctx.fillStyle='#cdd6f4';ctx.font='9px monospace';ctx.textAlign='center';ctx.fillText(n.ip,n.x,n.y+n.r+11)});

  ctx.fillStyle='rgba(166,173,200,.5)';ctx.font='9px sans-serif';ctx.textAlign='left';
  ctx.fillText('Blue = internal, Red = external, Line thickness = traffic volume',8,H-8);
}

function switchTab(el){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));el.classList.add('active');const p=document.getElementById('p-'+el.dataset.p);if(p)p.classList.add('active');if(el.dataset.p==='graph')setTimeout(drawGraph,50)}
function filterTables(q){const lq=q.toLowerCase();document.querySelectorAll('.filterable tr').forEach(tr=>{tr.style.display=tr.textContent.toLowerCase().includes(lq)?'':'none'})}

let currentStreamText='';
function openFinding(idx){
  const f=R.findings[idx];if(!f)return;$('#copyBtn').style.display='none';
  const modal=$('#modal'),body=$('#modalBody');$('#modalTitle').textContent=f.title;
  let h=`<div class="detail-grid"><div class="lbl">Severity</div><div><span class="sev sev-${f.severity}">${f.severity}</span></div><div class="lbl">Confidence</div><div>${(f.confidence*100).toFixed(0)}%</div><div class="lbl">Category</div><div>${f.category}</div><div class="lbl">MITRE</div><div>${f.mitre_attack.map(t=>`<span class="mitre">${t}</span>`).join(' ')||'-'}</div><div class="lbl">Description</div><div>${esc(f.description)}</div></div>`;
  if(f.evidence&&f.evidence.length){h+=`<h4 style="font-size:11px;color:var(--subtext);margin:8px 0 4px">Evidence (${f.evidence.length})</h4>`;
    f.evidence.forEach(e=>{h+=`<div class="evidence-item"><strong>${e.kind}</strong> ${esc(e.description)}${e.stream_id?` <span class="mono" style="color:var(--accent)">stream:${e.stream_id.slice(0,12)}</span>`:''}${e.artifact_id?` <span class="mono" style="color:var(--yellow)">artifact:${e.artifact_id.slice(0,12)}</span>`:''}</div>`})}
  if(f.pivots&&f.pivots.length){h+=`<h4 style="font-size:11px;color:var(--subtext);margin:8px 0 4px">Suggested Pivots</h4>`;
    f.pivots.forEach(p=>{h+=`<div class="evidence-item">${esc(p.description)}${p.query?` <code class="mono" style="color:var(--accent)">${esc(p.query)}</code>`:''}${p.command?` <code class="mono">${esc(p.command)}</code>`:''}</div>`})}
  body.innerHTML=h;modal.classList.add('open');
}

function openStream(idx){
  const s=R.streams[idx];if(!s)return;$('#copyBtn').style.display='inline-block';
  const modal=$('#modal'),body=$('#modalBody');$('#modalTitle').textContent=`Stream #${idx} - ${s.protocol} (${fmtB(s.total_bytes)}, ${s.segments.length} segs)`;
  currentStreamText='';
  let h=`<div style="margin-bottom:8px"><button class="toggle-hex" onclick="toggleHex(this)">Hex</button></div><div id="streamText">`;
  s.segments.forEach(seg=>{const isC=seg.direction==='client_to_server';const label=isC?'CLIENT':'SERVER';const cls=isC?'dir-client':'dir-server';const ccls=isC?'client':'server';
    let content=seg.data.map(b=>b>=32&&b<127?String.fromCharCode(b):(b===10?'\n':b===13?'':b===9?'\t':'.')).join('');
    currentStreamText+=`[${label}] ${content}\n`;content=highlightFlags(esc(content));
    h+=`<div class="seg"><div class="seg-header"><span class="${cls}">${isC?'&#9654;':'&#9664;'} ${label}</span><span style="color:var(--subtext);font-size:9px">${seg.data.length}B</span></div><div class="seg-content ${ccls}">${content}</div></div>`});
  h+=`</div><div id="streamHex" style="display:none">`;
  s.segments.forEach(seg=>{const isC=seg.direction==='client_to_server';const cls=isC?'dir-client':'dir-server';
    h+=`<div class="seg"><div class="seg-header"><span class="${cls}">${isC?'CLIENT':'SERVER'}</span></div><div class="seg-content" style="font-size:9px">`;
    for(let off=0;off<seg.data.length;off+=16){const sl=seg.data.slice(off,off+16);h+=`<span style="color:var(--overlay)">${off.toString(16).padStart(8,'0')}</span>  ${sl.map(b=>b.toString(16).padStart(2,'0')).join(' ').padEnd(47)}  <span style="color:var(--accent)">${esc(sl.map(b=>b>=32&&b<127?String.fromCharCode(b):'.').join(''))}</span>\n`}
    h+=`</div></div>`});
  h+=`</div>`;body.innerHTML=h;modal.classList.add('open');
}
function copyStream(){if(currentStreamText)navigator.clipboard.writeText(currentStreamText).then(()=>{$('#copyBtn').textContent='Copied!';setTimeout(()=>$('#copyBtn').textContent='Copy',1500)})}
function closeModal(){$('#modal').classList.remove('open');$('#copyBtn').style.display='none'}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()});
$('#modal').addEventListener('click',e=>{if(e.target===$('#modal'))closeModal()});
function toggleHex(btn){btn.classList.toggle('active');const t=$('#streamText'),hx=$('#streamHex');if(btn.classList.contains('active')){t.style.display='none';hx.style.display='block'}else{t.style.display='block';hx.style.display='none'}}
function highlightFlags(s){return s.replace(/([a-zA-Z]{2,12}\{[^}]{1,200}\})/g,'<span class="flag-highlight">$1</span>')}
function fmtB(b){if(b>=1073741824)return(b/1073741824).toFixed(1)+' GB';if(b>=1048576)return(b/1048576).toFixed(1)+' MB';if(b>=1024)return(b/1024).toFixed(1)+' KB';return b+' B'}
function esc(s){return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):''}
</script>
</body>
</html>
