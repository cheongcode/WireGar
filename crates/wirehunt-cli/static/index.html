<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WireHunt - Network Forensic Engine</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#1e1e2e;--surface:#313244;--overlay:#45475a;--text:#cdd6f4;--subtext:#a6adc8;--accent:#89b4fa;--green:#a6e3a1;--red:#f38ba8;--yellow:#f9e2af;--mauve:#cba6f7;--teal:#94e2d5;--pink:#f5c2e7;--peach:#fab387;--border:#585b70;--card:#181825;--client:#89b4fa;--server:#a6e3a1}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

.header{background:var(--card);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:100}
.logo{font-size:22px;font-weight:800;letter-spacing:-0.5px}
.logo span:first-child{color:var(--accent)}
.version{color:var(--subtext);font-size:12px}
.header-right{margin-left:auto;display:flex;gap:12px;align-items:center}
.btn{padding:7px 16px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;font-size:13px;transition:all .15s;font-family:inherit}
.btn:hover{border-color:var(--accent);color:var(--accent)}
.btn-primary{background:var(--accent);color:var(--bg);border-color:var(--accent);font-weight:600}
.btn-primary:hover{opacity:.85}

.container{max-width:1440px;margin:0 auto;padding:20px}

/* Drop zone */
.dropzone{border:2px dashed var(--border);border-radius:16px;padding:64px 40px;text-align:center;transition:all .2s;cursor:pointer;background:var(--card)}
.dropzone:hover,.dropzone.active{border-color:var(--accent);background:rgba(137,180,250,.05)}
.dropzone h2{font-size:20px;margin-bottom:6px}
.dropzone p{color:var(--subtext);font-size:13px}
.dropzone .icon{font-size:40px;margin-bottom:12px;opacity:.6}
.dropzone input{display:none}

.loading{text-align:center;padding:48px;display:none}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top:3px solid var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 12px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Dashboard */
.dashboard{display:none}

/* Flag banner */
.flag-banner{background:linear-gradient(135deg,rgba(243,139,168,.12),rgba(203,166,247,.12));border:1px solid var(--red);border-radius:12px;padding:16px 20px;margin-bottom:20px;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{border-color:var(--red)}50%{border-color:var(--mauve)}}
.flag-banner h3{color:var(--red);font-size:15px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.flag-value{font-family:'Cascadia Code','Fira Code',monospace;background:rgba(243,139,168,.1);color:var(--red);padding:4px 10px;border-radius:4px;font-size:14px;font-weight:700;display:inline-block;margin:3px 4px 3px 0}

/* Findings alert */
.findings-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:20px}
.findings-box h3{color:var(--peach);font-size:14px;margin-bottom:10px}
.finding-row{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(88,91,112,.3);font-size:13px}
.finding-row:last-child{border-bottom:none}
.sev{font-size:11px;font-weight:700;padding:2px 8px;border-radius:3px;min-width:60px;text-align:center}
.sev-Critical{background:rgba(243,139,168,.2);color:var(--red)}
.sev-High{background:rgba(245,194,231,.15);color:var(--pink)}
.sev-Medium{background:rgba(249,226,175,.15);color:var(--yellow)}
.sev-Low{background:rgba(148,226,213,.15);color:var(--teal)}
.sev-Info{background:rgba(166,173,200,.1);color:var(--subtext)}
.mitre{font-size:10px;color:var(--mauve);background:rgba(203,166,247,.1);padding:1px 6px;border-radius:3px}

/* File info */
.file-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:20px}
.fi .lbl{color:var(--subtext);font-size:10px;text-transform:uppercase;letter-spacing:.5px}
.fi .val{font-weight:600;font-size:13px;word-break:break-all}
.fi .hash{font-family:monospace;font-size:10px;color:var(--accent)}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}
.stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center}
.stat .v{font-size:28px;font-weight:800}
.stat .l{color:var(--subtext);font-size:11px;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.stat.a .v{color:var(--accent)}.stat.g .v{color:var(--green)}.stat.y .v{color:var(--yellow)}.stat.r .v{color:var(--red)}

/* Protocol chart */
.proto-chart{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:20px}
.proto-chart h3{font-size:13px;color:var(--subtext);margin-bottom:10px}
.proto-bar{display:flex;align-items:center;gap:10px;padding:4px 0;font-size:13px}
.proto-bar .name{min-width:80px;color:var(--accent);font-weight:600}
.proto-bar .bar{flex:1;height:20px;background:var(--surface);border-radius:4px;overflow:hidden}
.proto-bar .fill{height:100%;border-radius:4px;transition:width .5s}
.proto-bar .count{min-width:60px;text-align:right;color:var(--subtext);font-size:12px}

/* Search */
.search-bar{margin-bottom:16px}
.search-bar input{width:100%;padding:10px 16px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;outline:none;transition:border .15s}
.search-bar input:focus{border-color:var(--accent)}
.search-bar input::placeholder{color:var(--overlay)}

/* Tabs */
.tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);margin-bottom:16px;overflow-x:auto}
.tab{padding:9px 18px;cursor:pointer;color:var(--subtext);border-bottom:2px solid transparent;transition:all .12s;font-size:13px;font-weight:500;white-space:nowrap}
.tab:hover{color:var(--text)}.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab .cnt{font-size:11px;color:var(--overlay);margin-left:4px}

/* Tables */
.panel{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden;display:none}
.panel.active{display:block}
table{width:100%;border-collapse:collapse;font-size:12px}
th{text-align:left;padding:8px 14px;color:var(--subtext);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;background:var(--surface);position:sticky;top:0}
td{padding:8px 14px;border-top:1px solid rgba(88,91,112,.3)}
tr:hover td{background:rgba(137,180,250,.03)}
.proto-badge{font-weight:700;font-size:11px;padding:2px 7px;border-radius:3px;display:inline-block}
.pb-tcp{background:rgba(137,180,250,.15);color:var(--accent)}
.pb-udp{background:rgba(166,227,161,.15);color:var(--green)}
.pb-icmp{background:rgba(249,226,175,.15);color:var(--yellow)}
.m-GET{color:var(--green);font-weight:700}.m-POST{color:var(--yellow);font-weight:700}.m-PUT{color:var(--accent);font-weight:700}.m-DELETE{color:var(--red);font-weight:700}
.status{font-weight:700;font-size:11px;padding:1px 6px;border-radius:3px}
.s2{background:rgba(166,227,161,.15);color:var(--green)}.s3{background:rgba(249,226,175,.15);color:var(--yellow)}.s4{background:rgba(250,179,135,.15);color:var(--peach)}.s5{background:rgba(243,139,168,.15);color:var(--red)}
.dir{font-size:11px;font-weight:600;padding:1px 6px;border-radius:3px}
.dir-q{background:rgba(137,180,250,.12);color:var(--accent)}.dir-r{background:rgba(166,227,161,.12);color:var(--green)}
.cred-secret{font-family:'Cascadia Code',monospace;color:var(--red);font-size:11px;background:rgba(243,139,168,.06);padding:2px 5px;border-radius:3px;word-break:break-all}
.mono{font-family:'Cascadia Code','Fira Code',monospace;font-size:11px}
.empty{padding:32px;text-align:center;color:var(--overlay);font-size:13px}
.flag-highlight{background:rgba(243,139,168,.15);color:var(--red);font-weight:700;padding:0 2px;border-radius:2px}

/* Stream detail modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--bg);border:1px solid var(--border);border-radius:12px;width:90%;max-width:1000px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column}
.modal-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-header h3{color:var(--accent);font-size:15px}
.modal-body{padding:16px 20px;overflow-y:auto;flex:1}
.seg{margin-bottom:12px}
.seg-header{font-size:12px;font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.seg-header .dir-client{color:var(--client)}.seg-header .dir-server{color:var(--server)}
.seg-content{font-family:'Cascadia Code',monospace;font-size:12px;line-height:1.5;padding:10px 14px;background:var(--card);border-radius:6px;border:1px solid var(--border);white-space:pre-wrap;word-break:break-all;max-height:300px;overflow-y:auto}
.seg-content.client{border-left:3px solid var(--client)}.seg-content.server{border-left:3px solid var(--server)}
.hex-view{font-family:'Cascadia Code',monospace;font-size:11px;line-height:1.4;color:var(--subtext)}
.toggle-hex{font-size:11px;padding:3px 10px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer}
.toggle-hex.active{background:var(--accent);color:var(--bg);border-color:var(--accent)}
</style>
</head>
<body>

<div class="header">
  <div class="logo"><span>WIRE</span><span>HUNT</span></div>
  <span class="version" id="ver"></span>
  <div class="header-right">
    <button class="btn" id="exportBtn" style="display:none" onclick="exportJSON()">Export JSON</button>
    <button class="btn btn-primary" id="newBtn" style="display:none" onclick="reset()">New Scan</button>
  </div>
</div>

<div class="container">
  <div class="dropzone" id="dropzone" onclick="document.getElementById('fi').click()">
    <div class="icon">&#128194;</div>
    <h2>Drop your PCAP file here</h2>
    <p>or click to browse &mdash; .pcap and .pcapng up to 500 MB</p>
    <input type="file" id="fi" accept=".pcap,.pcapng,.cap"/>
  </div>
  <div class="loading" id="loading"><div class="spinner"></div><p>Analyzing capture...</p></div>
  <div class="dashboard" id="dash"></div>
</div>

<div class="modal-overlay" id="modal"><div class="modal"><div class="modal-header"><h3 id="modalTitle">Stream</h3><button class="btn" onclick="closeModal()">Close</button></div><div class="modal-body" id="modalBody"></div></div></div>

<script>
let R = null; // current report
const $=s=>document.querySelector(s);

// Drag & drop
const dz=$('#dropzone'), fi=$('#fi');
['dragenter','dragover'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.add('active')}));
['dragleave','drop'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.remove('active')}));
dz.addEventListener('drop',ev=>{if(ev.dataTransfer.files[0])upload(ev.dataTransfer.files[0])});
fi.addEventListener('change',()=>{if(fi.files[0])upload(fi.files[0])});

async function upload(file){
  dz.style.display='none';$('#loading').style.display='block';
  const form=new FormData();form.append('pcap',file);
  try{
    const res=await fetch('/api/analyze',{method:'POST',body:form});
    if(!res.ok)throw new Error(await res.text());
    R=await res.json();$('#loading').style.display='none';render();
  }catch(e){$('#loading').style.display='none';dz.style.display='block';alert('Error: '+e.message)}
}
function reset(){$('#dash').style.display='none';$('#dash').innerHTML='';dz.style.display='block';fi.value='';$('#exportBtn').style.display='none';$('#newBtn').style.display='none';R=null}
function exportJSON(){if(!R)return;const b=new Blob([JSON.stringify(R,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='wirehunt_report.json';a.click()}

function render(){
  const d=$('#dash');d.style.display='block';
  $('#exportBtn').style.display='inline-block';$('#newBtn').style.display='inline-block';
  const m=R.metadata;$('#ver').textContent='v'+m.wirehunt_version;

  // Collect flags from findings
  const flags=R.findings.filter(f=>f.category==='ctf_flag');
  const nonFlagFindings=R.findings.filter(f=>f.category!=='ctf_flag');

  let html='';

  // Flag banner
  if(flags.length>0){
    html+=`<div class="flag-banner"><h3>&#127937; ${flags.length} CTF Flag${flags.length>1?'s':''} Found!</h3><div>`;
    flags.forEach(f=>{
      const val=f.title.replace('CTF Flag Found: ','');
      html+=`<span class="flag-value">${esc(val)}</span>`;
    });
    html+=`</div></div>`;
  }

  // Findings box
  if(R.findings.length>0){
    html+=`<div class="findings-box"><h3>&#9888;&#65039; ${R.findings.length} Finding${R.findings.length>1?'s':''}</h3>`;
    R.findings.slice(0,12).forEach(f=>{
      const mitreHtml=f.mitre_attack.map(t=>`<span class="mitre">${t}</span>`).join(' ');
      html+=`<div class="finding-row"><span class="sev sev-${f.severity}">${f.severity}</span><span style="flex:1">${esc(f.title)}</span><span style="color:var(--subtext);font-size:11px">${(f.confidence*100).toFixed(0)}%</span>${mitreHtml}</div>`;
    });
    if(R.findings.length>12)html+=`<div style="padding:8px 0;color:var(--subtext);font-size:12px">...and ${R.findings.length-12} more</div>`;
    html+=`</div>`;
  }

  // File info
  html+=`<div class="file-info">
    <div class="fi"><div class="lbl">File</div><div class="val">${esc(m.pcap_filename)}</div></div>
    <div class="fi"><div class="lbl">SHA256</div><div class="val hash">${m.pcap_sha256.slice(0,24)}...</div></div>
    <div class="fi"><div class="lbl">Size</div><div class="val">${fmtB(m.pcap_size_bytes)}</div></div>
    <div class="fi"><div class="lbl">Packets</div><div class="val">${m.total_packets.toLocaleString()}</div></div>
    <div class="fi"><div class="lbl">Duration</div><div class="val">${m.capture_duration_secs.toFixed(1)}s</div></div>
    <div class="fi"><div class="lbl">Profile</div><div class="val">${m.profile}</div></div></div>`;

  // Stats
  html+=`<div class="stats">
    <div class="stat a"><div class="v">${R.flows.length}</div><div class="l">Flows</div></div>
    <div class="stat g"><div class="v">${R.streams.length}</div><div class="l">Streams</div></div>
    <div class="stat y"><div class="v">${R.artifacts.length}</div><div class="l">Artifacts</div></div>
    <div class="stat ${R.credentials.length?'r':''}"><div class="v">${R.credentials.length}</div><div class="l">Credentials</div></div>
    <div class="stat ${R.findings.length?'r':''}"><div class="v">${R.findings.length}</div><div class="l">Findings</div></div>
    <div class="stat"><div class="v">${R.dns_records.length}</div><div class="l">DNS</div></div>
    <div class="stat"><div class="v">${R.http_transactions.length}</div><div class="l">HTTP</div></div></div>`;

  // Protocol chart
  const pb=R.statistics.protocol_breakdown;const total=Object.values(pb).reduce((a,b)=>a+b,0);
  const sorted=Object.entries(pb).sort((a,b)=>b[1]-a[1]);
  const colors=['var(--accent)','var(--green)','var(--yellow)','var(--mauve)','var(--teal)','var(--pink)','var(--peach)'];
  if(sorted.length>0){
    html+=`<div class="proto-chart"><h3>PROTOCOL BREAKDOWN</h3>`;
    sorted.forEach(([name,count],i)=>{
      const pct=total>0?(count/total*100):0;
      html+=`<div class="proto-bar"><span class="name">${name}</span><div class="bar"><div class="fill" style="width:${pct}%;background:${colors[i%colors.length]}"></div></div><span class="count">${count} (${pct.toFixed(0)}%)</span></div>`;
    });
    html+=`</div>`;
  }

  // Search bar
  html+=`<div class="search-bar"><input type="text" placeholder="Search across all tables... (type to filter)" oninput="filterTables(this.value)"/></div>`;

  // Tabs
  const tabs=[
    {id:'flows',l:'Flows',c:R.flows.length},
    {id:'streams',l:'Streams',c:R.streams.length},
    {id:'http',l:'HTTP',c:R.http_transactions.length},
    {id:'dns',l:'DNS',c:R.dns_records.length},
    {id:'creds',l:'Credentials',c:R.credentials.length},
    {id:'artifacts',l:'Artifacts',c:R.artifacts.length},
  ];
  html+=`<div class="tabs">${tabs.map((t,i)=>`<div class="tab${i===0?' active':''}" data-p="${t.id}" onclick="switchTab(this)">${t.l}<span class="cnt">${t.c}</span></div>`).join('')}</div>`;

  // Panels
  // FLOWS
  html+=`<div class="panel active" id="p-flows"><table><thead><tr><th>#</th><th>Proto</th><th>Source</th><th>Destination</th><th>Pkts</th><th>Bytes</th><th>App</th><th>Flags</th></tr></thead><tbody class="filterable">`;
  R.flows.forEach((f,i)=>{
    const p=f.key.protocol;const pc=p==='tcp'?'pb-tcp':p==='udp'?'pb-udp':'pb-icmp';
    const fl=[];if(f.flags.syn)fl.push('SYN');if(f.flags.syn_ack)fl.push('SA');if(f.flags.fin)fl.push('FIN');if(f.flags.rst)fl.push('RST');if(f.flags.has_retransmits)fl.push('RETR');
    html+=`<tr><td>${i}</td><td><span class="proto-badge ${pc}">${p.toUpperCase()}</span></td><td class="mono">${f.key.src_ip}:${f.key.src_port}</td><td class="mono">${f.key.dst_ip}:${f.key.dst_port}</td><td>${f.packet_count}</td><td>${fmtB(f.byte_count)}</td><td>${f.detected_protocol||'-'}</td><td style="font-size:11px;color:var(--subtext)">${fl.join(' ')}</td></tr>`;
  });
  html+=`</tbody></table></div>`;

  // STREAMS
  html+=`<div class="panel" id="p-streams"><table><thead><tr><th>#</th><th>Proto</th><th>Bytes</th><th>Segs</th><th>Preview</th><th></th></tr></thead><tbody class="filterable">`;
  R.streams.forEach((s,i)=>{
    let prev='';if(s.segments.length>0){const b=s.segments[0].data;prev=b.map(c=>c>=32&&c<127?String.fromCharCode(c):'.').join('').slice(0,60)}
    prev=highlightFlags(esc(prev));
    html+=`<tr><td>${i}</td><td>${s.protocol}</td><td>${fmtB(s.total_bytes)}</td><td>${s.segments.length}</td><td class="mono" style="font-size:11px;color:var(--subtext)">${prev}</td><td><button class="btn" style="padding:3px 10px;font-size:11px" onclick="openStream(${i})">View</button></td></tr>`;
  });
  html+=`</tbody></table></div>`;

  // HTTP
  html+=`<div class="panel" id="p-http"><table><thead><tr><th>#</th><th>Method</th><th>Status</th><th>Host</th><th>URI</th><th>Type</th><th>Agent</th></tr></thead><tbody class="filterable">`;
  R.http_transactions.forEach((t,i)=>{
    const sc=t.status_code;const scl=sc?sc<300?'s2':sc<400?'s3':sc<500?'s4':'s5':'';
    html+=`<tr><td>${i}</td><td class="m-${t.method}">${t.method}</td><td>${sc?`<span class="status ${scl}">${sc}</span>`:'-'}</td><td>${esc(t.host||'-')}</td><td class="mono">${esc(t.uri)}</td><td style="font-size:11px">${esc(t.content_type||'-')}</td><td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--subtext)">${esc(t.user_agent||'-')}</td></tr>`;
  });
  html+=`</tbody></table></div>`;

  // DNS
  html+=`<div class="panel" id="p-dns"><table><thead><tr><th>#</th><th>Dir</th><th>Type</th><th>Query Name</th><th>Response</th><th>TTL</th></tr></thead><tbody class="filterable">`;
  R.dns_records.forEach((d,i)=>{
    html+=`<tr><td>${i}</td><td><span class="dir ${d.is_response?'dir-r':'dir-q'}">${d.is_response?'RESP':'QUERY'}</span></td><td style="color:var(--accent)">${d.record_type}</td><td class="mono">${highlightFlags(esc(d.query_name))}</td><td class="mono">${highlightFlags(esc(d.response_data.join(', ')))}</td><td style="color:var(--subtext)">${d.ttl||'-'}</td></tr>`;
  });
  html+=`</tbody></table></div>`;

  // CREDS
  html+=`<div class="panel" id="p-creds"><table><thead><tr><th>#</th><th>Type</th><th>User</th><th>Service</th><th>Secret</th></tr></thead><tbody class="filterable">`;
  R.credentials.forEach((c,i)=>{
    html+=`<tr><td>${i}</td><td style="color:var(--yellow)">${esc(c.kind)}</td><td>${esc(c.username||'-')}</td><td>${esc(c.service||'-')}</td><td><span class="cred-secret">${esc(c.secret.slice(0,80))}</span></td></tr>`;
  });
  html+=`</tbody></table></div>`;

  // ARTIFACTS
  html+=`<div class="panel" id="p-artifacts"><table><thead><tr><th>#</th><th>Type</th><th>Name</th><th>Size</th><th>MIME</th><th>SHA256</th></tr></thead><tbody class="filterable">`;
  R.artifacts.forEach((a,i)=>{
    html+=`<tr><td>${i}</td><td style="color:var(--yellow)">${esc(a.kind)}</td><td>${esc(a.name||'-')}</td><td>${fmtB(a.size_bytes)}</td><td style="font-size:11px">${esc(a.mime_type||'-')}</td><td class="mono" style="font-size:10px">${a.sha256.slice(0,20)}...</td></tr>`;
  });
  html+=`</tbody></table></div>`;

  d.innerHTML=html;
}

function switchTab(el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  const p=document.getElementById('p-'+el.dataset.p);if(p)p.classList.add('active');
}

function filterTables(q){
  const lq=q.toLowerCase();
  document.querySelectorAll('.filterable tr').forEach(tr=>{
    tr.style.display=tr.textContent.toLowerCase().includes(lq)?'':'none';
  });
}

function openStream(idx){
  const s=R.streams[idx];if(!s)return;
  const modal=$('#modal');const body=$('#modalBody');
  $('#modalTitle').textContent=`Stream #${idx} - ${s.protocol} (${fmtB(s.total_bytes)}, ${s.segments.length} segments)`;
  let html=`<div style="margin-bottom:10px"><button class="toggle-hex" onclick="toggleHex(this)" data-idx="${idx}">Hex View</button></div>`;
  html+=`<div id="streamText">`;
  s.segments.forEach((seg,i)=>{
    const dir=seg.direction;
    const isClient=dir==='client_to_server';
    const label=isClient?'&#9654; CLIENT':'&#9664; SERVER';
    const cls=isClient?'dir-client':'dir-server';
    const ccls=isClient?'client':'server';
    let content=seg.data.map(b=>b>=32&&b<127?String.fromCharCode(b):(b===10?'\n':b===13?'':b===9?'\t':'.')).join('');
    content=highlightFlags(esc(content));
    html+=`<div class="seg"><div class="seg-header"><span class="${cls}">${label}</span> <span style="color:var(--subtext);font-size:11px">${seg.data.length} bytes</span></div><div class="seg-content ${ccls}">${content}</div></div>`;
  });
  html+=`</div><div id="streamHex" style="display:none">`;
  s.segments.forEach((seg,i)=>{
    const isClient=seg.direction==='client_to_server';
    const label=isClient?'CLIENT':'SERVER';
    const cls=isClient?'dir-client':'dir-server';
    html+=`<div class="seg"><div class="seg-header"><span class="${cls}">${label}</span></div><div class="seg-content" style="font-size:11px">`;
    for(let off=0;off<seg.data.length;off+=16){
      const slice=seg.data.slice(off,off+16);
      const hexPart=slice.map(b=>b.toString(16).padStart(2,'0')).join(' ').padEnd(47);
      const ascPart=slice.map(b=>b>=32&&b<127?String.fromCharCode(b):'.').join('');
      html+=`<span style="color:var(--overlay)">${off.toString(16).padStart(8,'0')}</span>  ${hexPart}  <span style="color:var(--accent)">${esc(ascPart)}</span>\n`;
    }
    html+=`</div></div>`;
  });
  html+=`</div>`;
  body.innerHTML=html;modal.classList.add('open');
}
function closeModal(){$('#modal').classList.remove('open')}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()});
$('#modal').addEventListener('click',e=>{if(e.target===$('#modal'))closeModal()});

function toggleHex(btn){
  btn.classList.toggle('active');
  const text=$('#streamText'),hex=$('#streamHex');
  if(btn.classList.contains('active')){text.style.display='none';hex.style.display='block'}
  else{text.style.display='block';hex.style.display='none'}
}

function highlightFlags(s){
  return s.replace(/([a-zA-Z]{2,12}\{[^}]{1,200}\})/g,'<span class="flag-highlight">$1</span>');
}

function fmtB(b){if(b>=1073741824)return(b/1073741824).toFixed(1)+' GB';if(b>=1048576)return(b/1048576).toFixed(1)+' MB';if(b>=1024)return(b/1024).toFixed(1)+' KB';return b+' B'}
function esc(s){return s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):''}
</script>
</body>
</html>
